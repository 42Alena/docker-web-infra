# ===============================
# ğŸŒ Inception Project â€“ Makefile
# ===============================
# Manages the full lifecycle of your Dockerized infrastructure.
# ===============================

# ğŸ“‚ DATA PATHS
VM_DATA  = /home/akurmyza/data
MAC_DATA = /Users/$(shell whoami)/data
COMPOSE_FILE = srcs/docker-compose.yml

# ğŸš€ DEFAULT TARGET (Defense in VM)
all:
	@echo "ğŸš€ Starting Inception on School VM (defense)..."
	@if [ -d "$(VM_DATA)/mariadb" ]; then \
		echo "ğŸ“‚ $(VM_DATA)/mariadb already exists"; \
	else \
		mkdir -p $(VM_DATA)/mariadb && echo "âœ… Created $(VM_DATA)/mariadb"; \
	fi
	@if [ -d "$(VM_DATA)/wordpress" ]; then \
		echo "ğŸ“‚ $(VM_DATA)/wordpress already exists"; \
	else \
		mkdir -p $(VM_DATA)/wordpress && echo "âœ… Created $(VM_DATA)/wordpress"; \
	fi
	@echo "âœ… Volumes ready in $(VM_DATA)"
	DATA_PATH=$(VM_DATA) docker compose -f $(COMPOSE_FILE) -p inception up -d --build --force-recreate
	@echo "âœ… Running in VM, volumes in $(VM_DATA)"

# ğŸ’» MACBOOK TARGET
mac:
	@echo "ğŸš€ Starting Inception on MacBook..."
	@if [ -d "$(MAC_DATA)/mariadb" ]; then \
		echo "ğŸ“‚ $(MAC_DATA)/mariadb already exists"; \
	else \
		mkdir -p $(MAC_DATA)/mariadb && echo "âœ… Created $(MAC_DATA)/mariadb"; \
	fi
	@if [ -d "$(MAC_DATA)/wordpress" ]; then \
		echo "ğŸ“‚ $(MAC_DATA)/wordpress already exists"; \
	else \
		mkdir -p $(MAC_DATA)/wordpress && echo "âœ… Created $(MAC_DATA)/wordpress"; \
	fi
	@echo "âœ… Volumes ready in $(MAC_DATA)"
	DATA_PATH=$(MAC_DATA) docker compose -f $(COMPOSE_FILE) -p inception up -d --build --force-recreate
	@echo "âœ… Running on Mac, volumes in $(MAC_DATA)"

# â¹ DOWN
down:
	docker compose -f $(COMPOSE_FILE) -p inception down

# ğŸ§¹ CLEAN (safe + subject-proof)
clean:
	@echo "ğŸ§¹ Stopping all containers..."
	docker stop $$(docker ps -qa) 2>/dev/null || true
	@echo "ğŸ§¹ Removing all containers..."
	docker rm -f $$(docker ps -qa) 2>/dev/null || true
	@echo "ğŸ§¹ Removing all images..."
	docker rmi -f $$(docker images -qa) 2>/dev/null || true
	@echo "ğŸ§¹ Removing project volumes..."
	docker volume rm mariadb_data wordpress_data 2>/dev/null || true
	@echo "ğŸ§¹ Removing project network..."
	docker network rm inception 2>/dev/null || true
	@echo "âœ… Clean complete (project reset)"

# ğŸ”„ REBUILD
re: clean all
macre: clean mac

# ğŸ”¥ PRUNE (wipe absolutely everything âš ï¸)
prune:
	docker system prune -af --volumes

# ğŸ›¡ DEFENSE HELPERS
ps:
	@echo "ğŸ” Containers running:"
	docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"

net:
	@echo "ğŸ” Inspect custom network 'inception':"
	docker network inspect inception | grep -E '\"Name\"|\"Containers\"' || echo "âš ï¸ Network not found"

vols:
	@echo "ğŸ” Volumes (must point to /home/akurmyza/data or /Users/.../data):"
	docker volume ls
	docker volume inspect mariadb_data | grep Mountpoint || true
	docker volume inspect wordpress_data | grep Mountpoint || true

dbcheck:
	@echo "ğŸ” MariaDB databases and grants (with wait)..."
	@for i in 1 2 3 4 5; do \
		docker exec -e MYSQL_PWD=$$(grep DB_ROOT_PASS srcs/.env | cut -d '=' -f2) -it mariadb \
			mariadb -uroot -e "SHOW DATABASES; SHOW GRANTS FOR '$$(grep DB_USER srcs/.env | cut -d '=' -f2)'@'%';" \
		&& break || (echo "â³ Waiting for MariaDB... ($$i/5)"; sleep 2); \
	done



wpusers:
	@echo "ğŸ” WordPress users:"
	docker exec -it wordpress wp user list --allow-root

tlscheck:
	@echo "ğŸ” Check TLS 1.2 (âœ… should work)"
	openssl s_client -connect akurmyza.42.fr:443 -tls1_2 </dev/null | grep "Protocol" || true
	@echo "ğŸ” Check TLS 1.3 (âœ… should work)"
	openssl s_client -connect akurmyza.42.fr:443 -tls1_3 </dev/null | grep "Protocol" || true
	@echo "ğŸ” Check TLS 1.0 (âŒ should fail)"
	openssl s_client -connect akurmyza.42.fr:443 -tls1 </dev/null || true

# Run all defense checks together
defense: ps net vols dbcheck wpusers tlscheck
	@echo "âœ… Defense checks complete."

.PHONY: all mac down clean re macre prune ps net vols dbcheck wpusers tlscheck defense
