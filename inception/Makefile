# ===============================
# ğŸŒ Inception Project â€“ Makefile
# ===============================
# This Makefile manages the full lifecycle of your Dockerized infrastructure.
# It creates persistent folders, builds images, runs containers,
# and provides reset commands for testing persistence or fresh installs.
#
# ===============================
# ğŸ“– HOW TO USE (Cheat sheet)
# -------------------------------
# make        â†’ Build & run on School VM (/home/akurmyza/data)
# make mac    â†’ Build & run on Mac (/Users/<login>/data)
# make down   â†’ Stop containers, keep DB + WP data (persistence test âœ…)
# make re     â†’ Clean everything + rebuild (fresh install test âœ…)
# make macre  â†’ Same as "re" but for Mac
# make prune  â†’ Extreme cleanup (wipes ALL Docker data on system âš ï¸)
# ===============================

# -------------------------------
# ğŸ“‚ DATA PATHS
# -------------------------------
# VM_DATA  = Path used on School VM (defense requirement)
# MAC_DATA = Path used locally on MacBook (auto-detect username)
VM_DATA  = /home/akurmyza/data
MAC_DATA = /Users/$(shell whoami)/data

# Path to docker-compose configuration
COMPOSE_FILE = srcs/docker-compose.yml

# =====================================================
# ğŸš€ DEFAULT TARGET (Defense in VM)
# -----------------------------------------------------
# 1) Ensures persistence folders exist in /home/akurmyza/data
# 2) Starts project with docker compose:
#    -f $(COMPOSE_FILE) â†’ use our compose file
#    up                 â†’ create & start containers
#    -d                 â†’ detached (background)
#    --build            â†’ rebuild images if Dockerfiles changed
#    --force-recreate   â†’ always recreate containers/volumes (no prompts)
# =====================================================
all:
	@echo "ğŸš€ Starting Inception on School VM (defense)..."
	@if [ -d "$(VM_DATA)/mariadb" ]; then \
		echo "ğŸ“‚ $(VM_DATA)/mariadb already exists"; \
	else \
		mkdir -p $(VM_DATA)/mariadb && echo "âœ… Created $(VM_DATA)/mariadb"; \
	fi
	@if [ -d "$(VM_DATA)/wordpress" ]; then \
		echo "ğŸ“‚ $(VM_DATA)/wordpress already exists"; \
	else \
		mkdir -p $(VM_DATA)/wordpress && echo "âœ… Created $(VM_DATA)/wordpress"; \
	fi
	@echo "âœ… Volumes ready in $(VM_DATA)"
	docker compose -f $(COMPOSE_FILE) up -d --build --force-recreate
	@echo "âœ… Running in VM, volumes in $(VM_DATA)"

# =====================================================
# ğŸ’» MACBOOK TARGET (Optional for local dev)
# -----------------------------------------------------
# Same as "all" but uses /Users/<login>/data for persistence.
# USE ON MAC:
# make mac
# make macre
# =====================================================
mac:
	@echo "ğŸš€ Starting Inception on MacBook..."
	@if [ -d "$(MAC_DATA)/mariadb" ]; then \
		echo "ğŸ“‚ $(MAC_DATA)/mariadb already exists"; \
	else \
		mkdir -p $(MAC_DATA)/mariadb && echo "âœ… Created $(MAC_DATA)/mariadb"; \
	fi
	@if [ -d "$(MAC_DATA)/wordpress" ]; then \
		echo "ğŸ“‚ $(MAC_DATA)/wordpress already exists"; \
	else \
		mkdir -p $(MAC_DATA)/wordpress && echo "âœ… Created $(MAC_DATA)/wordpress"; \
	fi
	@echo "âœ… Volumes ready in $(MAC_DATA)"
	docker compose -f $(COMPOSE_FILE) up -d --build --force-recreate
	@echo "âœ… Running on Mac, volumes in $(MAC_DATA)"

# =====================================================
# â¹ DOWN TARGET
# -----------------------------------------------------
# docker compose down
# - Stops containers
# - Removes networks
# - Keeps volumes (DB + WP data persists âœ…)
# Use this to test persistence between restarts.
# =====================================================
down:
	docker compose -f $(COMPOSE_FILE) down

# =====================================================
# ğŸ§¹ CLEAN TARGET
# -----------------------------------------------------
# Project reset for defense:
# - Stops all containers
# - Removes containers, images, volumes, and networks
# - Data is lost âš ï¸
#
# Commands explained:
# docker stop $$(docker ps -qa)  â†’ stop all containers
# docker rm -f $$(docker ps -qa) â†’ remove all containers
# docker rmi -f $$(docker images -qa) â†’ remove all images
# docker volume rm $$(docker volume ls -q) â†’ delete all volumes
# docker network rm $$(docker network ls -q) â†’ delete all networks
# =====================================================
clean:
	docker stop $$(docker ps -qa) || true
	docker rm -f $$(docker ps -qa) || true
	docker rmi -f $$(docker images -qa) || true
	docker volume rm $$(docker volume ls -q) || true
	docker network rm $$(docker network ls -q) 2>/dev/null || true

# =====================================================
# ğŸ”„ REBUILD TARGETS
# -----------------------------------------------------
# re    = Clean + fresh rebuild (for School VM, defense use)
# macre = Clean + fresh rebuild (for MacBook dev)
# =====================================================
re: clean all
macre: clean mac

# =====================================================
# ğŸ”¥ PRUNE TARGET
# -----------------------------------------------------
# Extreme cleanup of ALL Docker data (not only Inception):
# docker system prune -af --volumes
# -a        â†’ remove ALL unused images
# -f        â†’ force (no confirmation)
# --volumes â†’ also delete unused volumes
# âš ï¸ Be careful: this wipes unrelated projects too!
# =====================================================
prune:
	docker system prune -af --volumes

.PHONY: all mac down clean re macre prune
